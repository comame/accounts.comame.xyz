<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="x-csrf-token" content="$CSRF" id="csrf-token">
    <title>Sign in</title>
</head>
<body>
    <label>user: <input readonly id="user_id_read"></label>
    <form id="form" action="">
        <label>User ID<input name="user_id" required></label>
        <label>Password<input name="password" type="password" required></label>
        <button type="submit">SIGN IN</button>
    </form>
    <button id="signout">SIGN OUT</button>
    <script>
        /** @type { HTMLFormElement } form */
        const form = document.getElementById("form")
        /** @type { HTMLMetaElement } tokenEl*/
        const tokenEl = document.getElementById('csrf-token')
        const idEl = document.getElementById('user_id_read')
        const signoutButton = document.getElementById('signout')

        fetch('/signin-session', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                csrf_token: tokenEl.content
            })
        }).then(res => res.json()).then(json => {
            console.log(json)
            idEl.value = json['user_id']
        })

        form.addEventListener("submit", e => {
            e.preventDefault()
            const formData = new FormData(form)
            const body = JSON.stringify({
                user_id: formData.get('user_id'),
                password: formData.get('password'),
                csrf_token: tokenEl.content,
            })
            fetch('/signin-password', {
                method: 'POST',
                body,
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(res => res.json()).then(json => {
                console.log(json)
                idEl.value = json['user_id']
            })
        })

        signoutButton.addEventListener('click', () => {
            fetch('/signout', {
                credentials: 'include'
            }).then(() => {
                location.reload()
            })
        })
    </script>
</body>
</html>
